<html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>CI &amp; CD · Stephen Lin&#x27;s Website</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta property="og:title" content="CI &amp; CD · Stephen Lin&#x27;s Website"/><meta property="og:type" content="website"/><meta property="og:url" content="https://facebook.github.io/portfoliodoc/index.html"/><meta property="og:description" content="[CircleCI](https://circleci.com) is used as the continuous integration and continuous deployment (CI/CD) platform. There are three `workflow`s in the pipeline, for building and deploying the website, typescript document and design document respectively."/><link rel="shortcut icon" href="/portfoliodoc/img/favicon/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/portfoliodoc/css/main.css"/></head><body class="sideNavVisible"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/portfoliodoc/"><h2 class="headerTitle">Stephen Lin&#x27;s Website</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li><a href="/portfoliodoc/docs/overview.html" target="_self">Design Docs</a></li><li><a href="https://sevenlol.github.io/PortfolioWebTSDoc/" target="_self">Typescript Doc</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Automation</span></h2></div><div class="navGroups"><div class="navGroup navGroupActive"><h3>Design</h3><ul><li class="navListItem"><a class="navItem" href="/portfoliodoc/docs/overview.html">Overview</a></li><li class="navListItem"><a class="navItem" href="/portfoliodoc/docs/architecture.html">Architecture</a></li><li class="navListItem"><a class="navItem" href="/portfoliodoc/docs/tech_stack.html">Technology Stack</a></li><li class="navListItem"><a class="navItem" href="/portfoliodoc/docs/repo.html">Git Repositories</a></li></ul></div><div class="navGroup navGroupActive"><h3>Website</h3><ul><li class="navListItem"><a class="navItem" href="/portfoliodoc/docs/web_app_structure.html">Application Structure</a></li><li class="navListItem"><a class="navItem" href="/portfoliodoc/docs/web_feature_home.html">Feature - Home</a></li><li class="navListItem"><a class="navItem" href="/portfoliodoc/docs/web_feature_about.html">Feature - About</a></li><li class="navListItem"><a class="navItem" href="/portfoliodoc/docs/web_feature_project.html">Feature - Project</a></li><li class="navListItem"><a class="navItem" href="/portfoliodoc/docs/db_schema.html">Database Schema</a></li><li class="navListItem"><a class="navItem" href="/portfoliodoc/docs/web_tests_n_docs.html">Tests and Documentations</a></li></ul></div><div class="navGroup navGroupActive"><h3>Automation</h3><ul><li class="navListItem navListItemActive"><a class="navItem navItemActive" href="/portfoliodoc/docs/ci_cd.html">CI &amp; CD</a></li><li class="navListItem"><a class="navItem" href="/portfoliodoc/docs/tools.html">Tools</a></li></ul></div></div></section></div><script>
          var toggler = document.getElementById('navToggler');
          var nav = document.getElementById('docsNav');
          toggler.onclick = function() {
            nav.classList.toggle('docsSliderActive');
          };
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1>CI &amp; CD</h1></header><article><div><span><p><a href="https://circleci.com">CircleCI</a> is used as the continuous integration and continuous deployment (CI/CD) platform. There are three <code>workflow</code>s in the pipeline, for building and deploying the website, typescript document and design document respectively.</p>
<h2><a class="anchor" aria-hidden="true" name="the-website"></a><a href="#the-website" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Website</h2>
<p>The workflow has three jobs, <code>test_web</code>, <code>build_web</code> and <code>deploy_web</code>, for testing, building and deploying the website. These jobs are executed in sequential order, where latter jobs depend on former ones. Triggers are configured so that only commits on <code>master</code> or <code>release</code> branch will run all three jobs. Commits on feature branches will only trigger <code>test_web</code>. Commits on <code>master</code> branch will be deployed to staging environment (a separate Firebase project), where I can view the new version. If the website on staging environment looks good, merging <code>master</code> into <code>release</code> branch will trigger a deployment to production environment. Staging and production configuration is set in environment variable with different name. Scripts in the <code>deploy_web</code> job will check the current branch and use the corresponding environment variables for deployment. Detail of each job can be found in the following sections.</p>
<p><img src="/portfoliodoc/docs/assets/website_ci_cd.png" alt="Workflow"></p>
<p><a href="https://github.com/sevenlol/Portfolio/blob/master/.circleci/config.yml">CircleCI Configuration YAML</a></p>
<h3><a class="anchor" aria-hidden="true" name="test-web"></a><a href="#test-web" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>test_web</h3>
<p>The steps of this job is listed below. Test results are exported using junit exporter and uploaded as an artifact to CircleCI. This allows CircleCI to parse the test results and show statistics on previous tests.</p>
<ol>
<li>checkout the commit that trigger this job</li>
<li>restore npm dependencies from cache (checksum of package.json is used as cache key)</li>
<li>install npm dependencies (noop if cache found)</li>
<li>save cache</li>
<li>run linting command for static analysis</li>
<li>perform unit tests</li>
<li>upload test results as artifact</li>
</ol>
<h3><a class="anchor" aria-hidden="true" name="build-web"></a><a href="#build-web" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>build_web</h3>
<p>This job build the website with production mode. Since Angular does not support its environment file referencing environment variables, a separate script is implemented to retrieve firebase website configurations in corresponding environment variables based on the current environment (<code>staging</code> or <code>production</code>). Firebase configuration is then written to <code>environment.production.ts</code> by the script.</p>
<ol>
<li>checkout the commit that trigger this job</li>
<li>restore npm dependencies from cache (checksum of package.json is used as cache key)</li>
<li>configure angular environment ts file based on current environment (<code>master</code> branch for <code>staging</code>, <code>release</code> for <code>production</code>).</li>
<li>build the website in production mode (optimization enabled)</li>
<li>store the built website in cache (branch + commit sha1 as cache key)</li>
</ol>
<p><img src="/portfoliodoc/docs/assets/circle_ci_env_1.png" alt="Env"></p>
<h3><a class="anchor" aria-hidden="true" name="deploy-web"></a><a href="#deploy-web" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>deploy_web</h3>
<p>This job deploy the website built in <code>build_web</code> job to Firebase Hosting using firebase command line tool. Firebase project name and token is set in environment variables, <code>FIREBASE_PROJECT_&lt;ENV&gt;</code> and <code>FIREBASE_TOKEN_&lt;ENV&gt;</code>, where <code>&lt;ENV&gt;</code> is the current environment (<code>STAGING</code> or <code>PROD</code>). For example, when a commit is pushed to <code>master</code> branch, <code>&lt;ENV&gt;</code> will be set to <code>STAGING</code>. <code>FIREBASE_PROJECT_STAGING</code> and <code>FIREBASE_TOKEN_STAGING</code> will be used in firebase command line tool to deploy the website.</p>
<ol>
<li>checkout the commit that trigger this job</li>
<li>restore npm dependencies from cache (for firebase cli)</li>
<li>restore built website from cache (branch + commit sha1 as cache key)</li>
<li>deploy to the correct firebase project use firebase CLI.</li>
</ol>
<h2><a class="anchor" aria-hidden="true" name="typescript-document"></a><a href="#typescript-document" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Typescript Document</h2>
<p>This <code>workflow</code> has two jobs, <code>build_web_ts_doc</code> and <code>deploy_web_ts_doc</code> for building and deploying typescript document website to github page (on another repo). In order to deploy to another repository, a machine <a href="https://circleci.com/docs/1.0/github-security-ssh-keys/">user key</a> is setup. A custom script is used to fetch the target repository, override old version with newly built document webiste, and push to <code>gh-pages</code> branch.</p>
<h3><a class="anchor" aria-hidden="true" name="build-web-ts-doc"></a><a href="#build-web-ts-doc" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>build_web_ts_doc</h3>
<p>This job build the typescript document with <code>Typedoc</code> command.</p>
<p><img src="/portfoliodoc/docs/assets/typedoc_ci_cd.png" alt="Workflow"></p>
<ol>
<li>checkout the commit that trigger this job</li>
<li>restore npm dependencies from cache</li>
<li>install npm dependencies (noop if cache found)</li>
<li>save cache</li>
<li>build typedoc</li>
<li>save built typescript document website to cache (branch + commit sha1 as cache key)</li>
</ol>
<h3><a class="anchor" aria-hidden="true" name="deploy-web-ts-doc"></a><a href="#deploy-web-ts-doc" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>deploy_web_ts_doc</h3>
<p>Target repository name is stored in an environment variable.</p>
<ol>
<li>checkout the commit that trigger this job</li>
<li>restore built document from cache</li>
<li>push to <code>gh-pages</code> branch on target repository</li>
</ol>
<pre><code class="hljs css bash">git init
git remote add --fetch origin <span class="hljs-variable">${WEB_TS_DOC_REPO}</span>
git config --global user.email <span class="hljs-variable">${GITHUB_EMAIL}</span>
git config --global user.name <span class="hljs-variable">${GITHUB_NAME}</span>
<span class="hljs-keyword">if</span> git rev-parse --verify origin/gh-pages &gt; /dev/null 2&gt;&amp;1
<span class="hljs-keyword">then</span>
    git checkout gh-pages
    git rm -rf .
<span class="hljs-keyword">else</span>
    git checkout --orphan gh-pages
<span class="hljs-keyword">fi</span>
cp -a ~/project/web/doc/. .
git add .
git commit -m <span class="hljs-string">"document"</span>
git push --force --quiet origin gh-pages &gt; /dev/null 2&gt;&amp;1
</code></pre>
<h2><a class="anchor" aria-hidden="true" name="design-document"></a><a href="#design-document" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Design Document</h2>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="web_tests_n_docs.html">← Tests and Documentations</a><a class="docs-next button" href="tools.html">Tools →</a></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><div><h5>Docs</h5><a href="/portfoliodoc/docs/en/architecture.html">Architecture</a><a href="/portfoliodoc/docs/en/web_app_structure.html">Web Application Structure</a><a href="/portfoliodoc/docs/en/ci_cd.html">CI/CD Pipeline</a></div><div><h5>Contacts</h5><a href="https://github.com/sevenlol">Github</a><a href="https://www.linkedin.com/in/stephen-lin-b211aa109/">LinkedIn</a><a href="https://sevenloldev.com">Portfolio</a></div></section><section class="copyright">This website is generated using Facebook&#x27;s Docusaurus</section><section class="copyright">Copyright © 2018 Stephen Lin</section></footer></div></body></html>